name: Release Publisher

# Runs exactly when you click "Publish release"
on:
  release:
    types: [published]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to upload assets to the release
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“ Inject Version into Manifest
        run: |
          # Grab the release tag (e.g., v1.3.0) and strip the 'v'
          TAG_NAME="${{ github.event.release.tag_name }}"
          CLEAN_VERSION="${TAG_NAME#v}"
          
          echo "Injecting version $CLEAN_VERSION into manifest..."
          jq ".version = \"$CLEAN_VERSION\"" custom_components/hyxi_cloud/manifest.json > tmp.json
          mv tmp.json custom_components/hyxi_cloud/manifest.json

      - name: ðŸ“¦ Create Zip Archive
        run: |
          # Go INSIDE the integration folder and zip the contents 
          # This ensures manifest.json is at the root of the zip file
          cd custom_components/hyxi_cloud
          zip -r ../../hyxi_cloud.zip .
          cd ../..

      - name: ðŸš€ Upload Zip to Release
        uses: softprops/action-gh-release@v2
        with:
          files: hyxi_cloud.zip