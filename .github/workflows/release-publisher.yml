name: Release Publisher

# This only runs when you click "Publish release" on a draft
on:
  release:
    types: [published]

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ðŸš€ This is the VIP Pass to push code
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main 

      - name: ðŸ“ Update Manifest Version
        run: |
          # 1. Grab the release tag (e.g., v1.3.0) and strip the 'v'
          TAG_NAME="${{ github.event.release.tag_name }}"
          CLEAN_VERSION="${TAG_NAME#v}"
          
          echo "Updating manifest.json to version: $CLEAN_VERSION"
          
          # 2. Use jq to safely inject the new version into the JSON
          jq ".version = \"$CLEAN_VERSION\"" custom_components/hyxi_cloud/manifest.json > tmp.json
          mv tmp.json custom_components/hyxi_cloud/manifest.json

      - name: ðŸ’¾ Commit and Push directly to main
        run: |
          # 3. Tell git who is making the commit (the automated bot)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 4. Commit and push!
          git add custom_components/hyxi_cloud/manifest.json
          # Only commit if there was actually a change
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: bump manifest version to $TAG_NAME ðŸš€" && git push)